#!/usr/bin/env bash

set -e

echo "Bob installer"

echo "Fetching version information..."

GITHUB_USER_NAME="MordechaiHadad"
GITHUB_PROJECT_NAME="bob"
LATEST_VERSION=$(curl -s https://api.github.com/repos/$GITHUB_USER_NAME/$GITHUB_PROJECT_NAME/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")' | sed 's/^v//')

echo "Latest version: ${LATEST_VERSION}"

DOWNLOAD_URL="https://github.com/$GITHUB_USER_NAME/$GITHUB_PROJECT_NAME/releases/download/${LATEST_VERSION}/bob-linux-x86_64.zip"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
BIN_DIR="$SCRIPT_DIR/bin"

# Check if bob executable already exists and if so, which version it has
# --version output looks like this: "bob-nvim 1.2.1"
if [ -f "$BIN_DIR/bob" ]; then
  CURRENT_VERSION=$("$BIN_DIR/bob" --version | grep -oP '\d+\.\d+\.\d+')
  echo "Current version: ${CURRENT_VERSION}"

  if [ "$CURRENT_VERSION" == "$LATEST_VERSION" ]; then
    echo "Already up to date"
    exit 0
  fi
fi

echo "Downloading and unzipping..."

mkdir -p "$BIN_DIR"
curl -L "$DOWNLOAD_URL" | bsdtar -xvf - -C "$BIN_DIR"

echo "Setting permissions..."
chmod u+x "$BIN_DIR/bob"

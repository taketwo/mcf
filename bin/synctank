#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.14"
# dependencies = [
#     "click>=8.3.1",
# ]
# ///

"""Manage synced ephemeral notes directories across machines.

A tool for managing per-project notes directories that sync across machines via external
sync tools (Syncthing, Dropbox, etc.).
"""

import os
import subprocess
from pathlib import Path

import click


def get_synctank_dir() -> Path:
    """Get the base synctank directory from environment or default."""
    return Path(os.environ.get("SYNCTANK_DIR", "~/Synctank")).expanduser()


def ensure_git_excluded(dir_name: str) -> None:
    """Ensure symlink is excluded from git if in a repository."""
    cwd = Path.cwd()
    try:
        result = subprocess.run(
            ["git", "rev-parse", "--git-path", "info/exclude"],
            cwd=cwd,
            capture_output=True,
            text=True,
            check=True,
        )
    except (subprocess.CalledProcessError, FileNotFoundError):
        # Not in a git repo, silently return
        return

    repo_root, exclude_file = map(Path, result.stdout.strip().split("\n"))
    if not exclude_file.is_absolute():
        exclude_file = (cwd / exclude_file).resolve()

    exclude_file.parent.mkdir(parents=True, exist_ok=True)
    existing_excludes = set()
    if exclude_file.exists():
        existing_excludes = set(exclude_file.read_text().splitlines())

    exclude_path = str(cwd.relative_to(repo_root) / dir_name)
    if exclude_path not in existing_excludes:
        with exclude_file.open("a") as f:
            f.write(f"{exclude_path}\n")
        click.echo(f"Added {exclude_path} to .git/info/exclude")


def get_project_name(name: str | None) -> str:
    """Get project name, defaulting to current directory name if not provided."""
    return name or Path.cwd().name


def create_symlink_and_exclude(project_dir: Path, dir_name: str) -> None:
    """Create symlink to project directory and add to git exclude."""
    symlink_path = Path.cwd() / dir_name
    if symlink_path.exists():
        raise click.ClickException(f"{symlink_path} already exists")

    symlink_path.symlink_to(project_dir)
    click.echo(f"Symlinked ./{dir_name} -> {project_dir}/")

    ensure_git_excluded(dir_name)


@click.group()
def cli() -> None:
    """Manage synced ephemeral notes directories across machines."""


@cli.command()
@click.argument("name", required=False)
@click.option("--dir", "dir_name", default="notes", help="Local symlink name")
def init(name: str | None, dir_name: str) -> None:
    """Initialize a new project's notes directory.

    NAME is the project identifier. If not provided, defaults to current directory name.
    """
    project_name = get_project_name(name)
    synctank_dir = get_synctank_dir()
    project_dir = synctank_dir / project_name

    if project_dir.exists():
        raise click.ClickException(
            f"Project '{project_name}' already exists in {synctank_dir}",
        )

    project_dir.mkdir(parents=True, exist_ok=True)
    click.echo(f"Created {project_dir}/")

    create_symlink_and_exclude(project_dir, dir_name)


@cli.command()
@click.argument("name", required=False)
@click.option("--dir", "dir_name", default="notes", help="Local symlink name")
def link(name: str | None, dir_name: str) -> None:
    """Link to an existing project's notes directory.

    NAME is the project identifier. If not provided, defaults to current directory name.
    """
    project_name = get_project_name(name)
    synctank_dir = get_synctank_dir()
    project_dir = synctank_dir / project_name

    if not project_dir.exists():
        raise click.ClickException(
            f"Project '{project_name}' not found in {synctank_dir}",
        )

    create_symlink_and_exclude(project_dir, dir_name)


@cli.command()
def status() -> None:
    """Show current directory's synctank state."""
    cwd = Path.cwd()
    synctank_dir = get_synctank_dir()

    linked = False
    for item in cwd.iterdir():
        if item.is_symlink():
            target = item.resolve()
            try:
                target.relative_to(synctank_dir)
                project_name = target.relative_to(synctank_dir).parts[0]
                click.echo(f"Project: {project_name}")
                click.echo(f"Symlink: {item.name} -> {target}")
                linked = True
                break
            except ValueError:
                # Not under synctank_dir, skip
                continue

    if not linked:
        click.echo("Not linked to synctank.")


@cli.command("list")
def list_projects() -> None:
    """List all projects in synctank directory."""
    synctank_dir = get_synctank_dir()

    if not synctank_dir.exists():
        click.echo(f"Synctank directory does not exist: {synctank_dir}")
        return

    projects = sorted(
        d.name
        for d in synctank_dir.iterdir()
        if d.is_dir() and not d.name.startswith(".")
    )

    if not projects:
        click.echo("No projects found.")
    else:
        for project in projects:
            click.echo(project)


if __name__ == "__main__":
    cli()
